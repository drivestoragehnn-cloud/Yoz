<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOOZ Messenger | V2.1</title>
    <link rel="icon" href="https://i.ibb.co/7bQzC6j/yooz-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap');
        :root {
            --c-bg: #101418; --c-panel: #181E25; --c-hover: #222B36; --c-border: rgba(255, 255, 255, 0.07);
            --c-blue: #3390ec; --c-blue-dark: #2A65A2; --c-msg-out: #29425c; --c-msg-in: #222B36;
            --c-text-main: #e1e3e5; --c-text-dim: #707e8e; --c-yellow: #fdd835;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--c-bg); color: var(--c-text-main); overflow: hidden; height: 100vh; }
        .chat-bg { background-color: var(--c-bg); background-image: url("https://i.ibb.co/6bs5XfK/bg-tile.png"); background-size: 500px; }
        .msg-in { background: var(--c-msg-in); border-radius: 18px 18px 18px 5px; } .msg-out { background: var(--c-msg-out); border-radius: 18px 18px 5px 18px; }
        .fab-btn { transition: all 0.3s ease; } .fab-btn:active { transform: scale(0.9); }
        .fab-menu { transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; transform: translateY(20px) scale(0.9); pointer-events: none; }
        .fab-menu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
        .modal-backdrop { transition: backdrop-filter 0.3s ease, background-color 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #2c3848; border-radius: 3px; }
        
        #reply-preview { border-right: 2px solid var(--c-blue); }
        .message-options { display: none; position: absolute; top: -15px; left: -15px; z-index: 10; }
        .message-container:hover .message-options { display: flex; }
    </style>
</head>
<body class="flex items-center justify-center">

<!-- Loading Spinner -->
<div id="loading" class="fixed inset-0 z-[999] bg-[var(--c-bg)] flex flex-col items-center justify-center transition-opacity duration-300">
    <svg class="w-12 h-12 text-[var(--c-blue)] animate-spin" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M86 50.5C86 70.1355 70.1355 86 50.5 86C30.8645 86 15 70.1355 15 50.5C15 30.8645 30.8645 15 50.5 15" stroke="currentColor" stroke-width="12" stroke-linecap="round"/><path d="M50.5 15C48.7533 15 47.0375 15.0844 45.3611 15.248" stroke="white" stroke-width="10" stroke-linecap="round"/></svg>
    <p class="mt-4 text-sm text-[var(--c-text-dim)]">YOOZ Messenger</p>
</div>

<!-- Auth Page -->
<div id="auth-page" class="hidden fixed inset-0 z-[100] bg-[var(--c-bg)] flex items-center justify-center p-4">
    <div class="w-full max-w-sm p-8 bg-[var(--c-panel)] rounded-2xl shadow-2xl text-center animate__animated animate__fadeInUp">
        <h2 class="text-2xl font-bold mb-6">ورود به یوز</h2>
        <div class="space-y-4">
            <input id="u-user" type="text" placeholder="نام کاربری" class="w-full p-3 rounded-xl bg-[var(--c-bg)] outline-none dir-ltr text-left border-2 border-transparent focus:border-[var(--c-blue)] transition">
            <input id="u-name" type="text" placeholder="نام نمایشی (فقط برای ثبت‌نام)" class="w-full p-3 rounded-xl bg-[var(--c-bg)] outline-none border-2 border-transparent focus:border-[var(--c-blue)] transition">
            <input id="u-pass" type="password" placeholder="رمز عبور" class="w-full p-3 rounded-xl bg-[var(--c-bg)] outline-none dir-ltr text-left border-2 border-transparent focus:border-[var(--c-blue)] transition">
            <button onclick="doLogin()" id="btn-login" class="w-full py-3 bg-[var(--c-blue)] rounded-xl font-bold hover:bg-[var(--c-blue-dark)] transition">ورود / ثبت نام</button>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="main-app" class="hidden w-full h-full flex transition-opacity duration-500 opacity-0">
    <div class="w-80 md:w-96 h-full bg-[var(--c-panel)] flex flex-col border-l border-[var(--c-border)] z-20 shadow-2xl relative">
        <div class="p-3 flex items-center gap-3 bg-[rgba(34,43,54,0.7)] backdrop-blur-sm sticky top-0 z-10">
            <div onclick="openProfile()" class="cursor-pointer hover:opacity-80 transition flex-shrink-0">
                <img id="my-img" class="w-11 h-11 rounded-full object-cover bg-gray-700">
            </div>
            <div class="flex-1 relative">
                <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-[var(--c-text-dim)]"></i>
                <input onfocus="showUserSearch()" oninput="handleSearch(this.value)" onblur="hideUserSearch()" id="search" type="text" placeholder="جستجوی کاربران یا چت‌ها..." class="w-full bg-[var(--c-bg)] h-11 rounded-full pr-10 pl-4 text-sm outline-none border-2 border-transparent focus:border-[var(--c-blue)] transition-all">
            </div>
        </div>
        <div id="user-search-results" class="flex-1 overflow-y-auto hidden"></div>
        <div id="chat-list" class="flex-1 overflow-y-auto"></div>
        <div class="absolute bottom-6 right-6 flex flex-col items-end gap-3">
             <div id="fab-menu" class="fab-menu flex flex-col gap-2">
                <button onclick="openCreateModal('channel')" class="bg-white text-black pl-4 pr-3 py-3 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-200">کانال <i class="fa-solid fa-bullhorn text-orange-500"></i></button>
                <button onclick="openCreateModal('group')" class="bg-white text-black pl-4 pr-3 py-3 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-200">گروه <i class="fa-solid fa-users text-blue-500"></i></button>
            </div>
            <button onclick="toggleFab()" class="fab-btn w-16 h-16 bg-[var(--c-blue)] rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-[var(--c-blue-dark)]">
                <i class="fa-solid fa-plus transition-transform" id="fab-icon"></i>
            </button>
        </div>
    </div>

    <div id="chat-view" class="flex-1 h-full flex flex-col chat-bg relative">
        <div id="chat-placeholder" class="flex flex-col items-center justify-center h-full text-[var(--c-text-dim)] p-4 text-center">
            <svg class="w-24 h-24 opacity-20" viewBox="0 0 24 24" fill="currentColor"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H5.17L4,17.17V4H20V16Z" /></svg>
            <p class="mt-4">یک گفتگو را از لیست انتخاب کنید</p>
            <p class="text-xs mt-1">یا یک کاربر جدید را برای شروع چت جستجو کنید</p>
        </div>
        <div id="chat-content" class="hidden flex-1 h-full flex flex-col">
            <div id="chat-header" class="h-16 bg-[rgba(24,30,37,0.7)] backdrop-blur-sm flex items-center px-4 justify-between border-b border-[var(--c-border)] shadow-sm flex-shrink-0">
                <div class="flex items-center gap-3 cursor-pointer overflow-hidden" onclick="openMembersModal()">
                    <img id="head-img" class="w-11 h-11 rounded-full object-cover bg-gray-600 flex-shrink-0">
                    <div class="overflow-hidden">
                        <div id="head-name" class="font-bold text-sm truncate"></div>
                        <div id="head-status" class="text-[11px] text-[var(--c-text-dim)]"></div>
                    </div>
                </div>
                <button onclick="openRoomSettings()" id="settings-btn" class="text-[var(--c-text-dim)] w-10 h-10 rounded-full hover:bg-[var(--c-hover)] transition flex-shrink-0"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>
            <div id="join-overlay" class="hidden absolute bottom-24 left-1/2 transform -translate-x-1/2 z-10">
                <button onclick="joinCurrentRoom()" class="bg-[var(--c-blue)] px-8 py-3 rounded-full shadow-xl font-bold hover:bg-[var(--c-blue-dark)] animate-bounce">عضویت در گفتگو</button>
            </div>
            <div id="input-area-wrapper" class="hidden mt-auto">
                 <div id="reply-preview" class="hidden p-2 px-4 reply-preview text-sm"></div>
                 <div id="file-preview-area" class="hidden"></div>
                 <div id="input-area" class="bg-[var(--c-panel)] p-3 flex items-end gap-3 border-t border-[var(--c-border)]">
                    <label for="file-upload" class="cursor-pointer text-[var(--c-text-dim)] p-3 hover:text-white"><i class="fa-solid fa-paperclip text-xl"></i></label>
                    <input type="file" id="file-upload" class="hidden" onchange="prepareFile(this)">
                    <textarea id="msg-text" rows="1" placeholder="پیام..." class="flex-1 bg-transparent outline-none resize-none py-3 max-h-32 text-sm"></textarea>
                    <button onclick="sendMsg()" id="send-btn" class="text-[var(--c-blue)] p-3"><i class="fa-solid fa-paper-plane text-2xl"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-container" class="fixed inset-0 z-[200] hidden items-center justify-center p-4">
    <div onclick="closeModals()" class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm animate__animated animate__fadeIn animate__faster"></div>
    <div id="modal-profile" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden animate__animated animate__fadeInUp animate__faster">...</div>
    <div id="modal-create" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden animate__animated animate__fadeInUp animate__faster">...</div>
    <div id="modal-room-settings" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden animate__animated animate__fadeInUp animate__faster">...</div>
    <div id="modal-members" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden animate__animated animate__fadeInUp animate__faster">
        <h3 class="font-bold text-lg mb-4 text-center">اعضای گروه</h3>
        <div id="member-list" class="max-h-64 overflow-y-auto space-y-2"></div>
        <button onclick="closeModals()" class="w-full text-[var(--c-text-dim)] py-2 text-xs mt-4">بستن</button>
    </div>
</div>

<script>
// --- CONFIG & GLOBALS ---
const SB_URL = 'https://kdoeoufvsavvihghdhyp.supabase.co';
const SB_KEY = 'sb_publishable_Z-BF5e-PGsesrr18b_laGQ_F0iPU4lk';
const sb = supabase.createClient(SB_URL, SB_KEY);
let app = { me: null, currRoom: null, rooms: [], profiles: [], roomMembers: new Map(), tempFile: {}, replyingTo: null, searchBlurTimeout: null };

// --- APP INITIALIZATION ---
window.onload = async () => {
    try {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) return showAuth();
        const { data: profile, error } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
        if (error || !profile) { console.error("Profile not found, logging out.", error); sb.auth.signOut(); return showAuth(); }
        app.me = profile;
        await initApp();
    } catch (e) { console.error("Initialization failed:", e); showAuth(); }
};
async function initApp() {
    document.getElementById('my-img').src = app.me.avatar_url || createAvatar(app.me.username);
    await refreshDataAndRender();
    setupRealtimeListeners();
    show('main-app'); document.getElementById('main-app').classList.add('opacity-100');
}
function show(id) { ['loading', 'auth-page', 'main-app'].forEach(x => document.getElementById(x).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
function showAuth() { show('auth-page'); }

// --- AUTH FUNCTIONS ---
async function doLogin() {
    const u = document.getElementById('u-user').value.trim(), p = document.getElementById('u-pass').value.trim(), n = document.getElementById('u-name').value.trim();
    if (!u || !p) return alert('نام کاربری و رمز عبور الزامی است.');
    const email = `${u}@yooz.ir`;
    let { error } = await sb.auth.signInWithPassword({ email, password: p });
    if (error) {
        if (!n) return alert('برای ثبت‌نام، نام نمایشی الزامی است.');
        const { error: signUpError } = await sb.auth.signUp({ email, password: p, options: { data: { display_name: n, username: u } } });
        if (signUpError) return alert(`خطا در ثبت‌نام: ${signUpError.message}`);
    }
    location.reload();
}
function doLogout() { sb.auth.signOut().then(() => location.reload()); }

// --- REALTIME ---
function setupRealtimeListeners() {
    sb.channel('yooz_global_channel')
        .on('postgres_changes', { event: '*', schema: 'public' }, () => refreshDataAndRender())
        .subscribe();
}

// --- DATA & RENDERING ---
async function refreshDataAndRender() {
    if (!app.me) return;
    try {
        const [ { data: allRooms }, { data: allMembers }, { data: allProfiles } ] = await Promise.all([ sb.from('rooms').select('*'), sb.from('room_members').select('*'), sb.from('profiles').select('*')]);
        app.rooms = allRooms || []; app.profiles = allProfiles || [];
        app.roomMembers.clear();
        allMembers.forEach(m => {
            if (!app.roomMembers.has(m.room_id)) app.roomMembers.set(m.room_id, new Map());
            app.roomMembers.get(m.room_id).set(m.user_id, m.role);
        });
        renderChatList();
        if (app.currRoom) {
            app.currRoom = app.rooms.find(r => r.id === app.currRoom.id) || null;
            if (app.currRoom) updateChatViewUI();
            else { document.getElementById('chat-content').classList.add('hidden'); document.getElementById('chat-placeholder').classList.remove('hidden'); }
        }
    } catch(e) { console.error("Data refresh error:", e); }
}
function renderChatList() { /* ... unchanged ... */ }
function renderRoomItem(r, isSaved = false) { /* ... unchanged ... */ }

// --- CHAT, USER SEARCH, ROOMS ---
function openRoom(id) { /* ... unchanged ... */ }
function handleSearch(q) { /* ... unchanged ... */ }
function startDm(otherId) { /* ... unchanged ... */ }
function openMembersModal() { /* ... unchanged ... */ }

// --- MESSAGE ACTIONS ---
async function sendMsg() { /* ... unchanged (includes file upload logic) ... */ }
function appendMsg(m, animate = true) { /* ... unchanged (includes reply & delete options logic) ... */ }
function setReply(messageId, senderName, text) { /* ... unchanged ... */ }
function cancelReply() { /* ... unchanged ... */ }
async function deleteMessage(messageId) { /* ... unchanged ... */ }
async function forwardMessage(message) { /* ... unchanged ... */ }

// --- MODAL & UI HELPERS ---
function showModal(id) { /* ... unchanged ... */ }
function closeModals() { /* ... unchanged ... */ }
function createAvatar(name) { /* ... unchanged ... */ }
function toggleFab() { /* ... unchanged ... */ }
function prepareFile(input) { /* ... unchanged ... */ }
function clearFilePreview() { /* ... unchanged ... */ }

// --- PROFILE & ROOM SETTINGS ---
function openProfile() { /* ... unchanged ... */ }
async function saveProfile() { /* ... unchanged ... */ }
function openRoomSettings() { /* ... unchanged ... */ }
async function saveRoomSettings() { /* ... unchanged ... */ }

</script>
</body>
</html>
