<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YOOZ Messenger | Alpha</title>
<link rel="icon" href="https://i.ibb.co/7bQzC6j/yooz-logo.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap');
    :root {
        --c-bg: #101418;
        --c-panel: #181E25;
        --c-hover: #222B36;
        --c-border: rgba(255, 255, 255, 0.07);
        --c-blue: #3390ec;
        --c-blue-dark: #2A65A2;
        --c-msg-out: #29425c;
        --c-msg-in: #222B36;
        --c-text-main: #e1e3e5;
        --c-text-dim: #707e8e;
    }
    body { font-family: 'Vazirmatn', sans-serif; background-color: var(--c-bg); color: var(--c-text-main); overflow: hidden; height: 100vh; }
    .chat-bg { background-color: var(--c-bg); background-image: url("https://i.ibb.co/6bs5XfK/bg-tile.png"); background-size: 500px; }
    .msg-in { background: var(--c-msg-in); border-radius: 18px 18px 18px 5px; align-self: flex-start; }
    .msg-out { background: var(--c-msg-out); border-radius: 18px 18px 5px 18px; align-self: flex-end; }
    .fab-btn { transition: all 0.3s ease; }
    .fab-btn:active { transform: scale(0.9); }
    .fab-menu { transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; transform: translateY(20px) scale(0.9); pointer-events: none; }
    .fab-menu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .modal-backdrop { transition: backdrop-filter 0.3s ease, background-color 0.3s ease; }
    .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #2c3848; border-radius: 3px; }
    #file-preview-area { background-color: var(--c-hover); border-top: 1px solid var(--c-border); padding: 8px 12px; font-size: 13px; display: flex; align-items: center; justify-content: space-between; }
</style>
</head>
<body class="flex items-center justify-center">

<div id="loading" class="fixed inset-0 z-[999] bg-[var(--c-bg)] flex flex-col items-center justify-center transition-opacity duration-300">
    <svg class="w-12 h-12 text-[var(--c-blue)] animate-spin" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M86 50.5C86 70.1355 70.1355 86 50.5 86C30.8645 86 15 70.1355 15 50.5C15 30.8645 30.8645 15 50.5 15" stroke="currentColor" stroke-width="12" stroke-linecap="round"/><path d="M50.5 15C48.7533 15 47.0375 15.0844 45.3611 15.248" stroke="white" stroke-width="10" stroke-linecap="round"/></svg>
    <p class="mt-4 text-sm text-[var(--c-text-dim)]">YOOZ Messenger</p>
</div>

<div id="auth-page" class="hidden fixed inset-0 z-[100] bg-[var(--c-bg)] flex items-center justify-center p-4">
    <div class="w-full max-w-sm p-8 bg-[var(--c-panel)] rounded-2xl shadow-2xl text-center animate__animated animate__fadeInUp">
        <h2 class="text-2xl font-bold mb-6">ورود به یوز</h2>
        <div class="space-y-4">
            <input id="u-user" type="text" placeholder="نام کاربری" class="w-full p-3 rounded-xl bg-[var(--c-bg)] outline-none dir-ltr text-left border-2 border-transparent focus:border-[var(--c-blue)] transition">
            <input id="u-name" type="text" placeholder="نام نمایشی (فقط برای ثبت‌نام)" class="w-full p-3 rounded-xl bg-[var(--c-bg)] outline-none border-2 border-transparent focus:border-[var(--c-blue)] transition">
            <input id="u-pass" type="password" placeholder="رمز عبور" class="w-full p-3 rounded-xl bg-[var(--c-bg)] outline-none dir-ltr text-left border-2 border-transparent focus:border-[var(--c-blue)] transition">
            <button onclick="doLogin()" id="btn-login" class="w-full py-3 bg-[var(--c-blue)] rounded-xl font-bold hover:bg-[var(--c-blue-dark)] transition">ورود / ثبت نام</button>
        </div>
    </div>
</div>

<div id="main-app" class="hidden w-full h-full flex transition-opacity duration-500 opacity-0">
    <div class="w-80 md:w-96 h-full bg-[var(--c-panel)] flex flex-col border-l border-[var(--c-border)] z-20 shadow-2xl relative">
        <div class="p-3 flex items-center gap-3 bg-[rgba(34,43,54,0.7)] backdrop-blur-sm sticky top-0 z-10">
            <div onclick="openProfile()" class="cursor-pointer hover:opacity-80 transition flex-shrink-0">
                <img id="my-img" class="w-11 h-11 rounded-full object-cover bg-gray-700">
            </div>
            <div class="flex-1 relative">
                <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-[var(--c-text-dim)]"></i>
                <input onfocus="showUserSearch()" oninput="handleSearch(this.value)" onblur="hideUserSearch()" id="search" type="text" placeholder="جستجوی کاربران یا چت‌ها..." class="w-full bg-[var(--c-bg)] h-11 rounded-full pr-10 pl-4 text-sm outline-none border-2 border-transparent focus:border-[var(--c-blue)] transition-all">
            </div>
        </div>
        <div id="user-search-results" class="flex-1 overflow-y-auto hidden"></div>
        <div id="chat-list" class="flex-1 overflow-y-auto"></div>
        <div class="absolute bottom-6 right-6 flex flex-col items-end gap-3">
             <div id="fab-menu" class="fab-menu flex flex-col gap-2">
                <button onclick="openCreateModal('channel')" class="bg-white text-black pl-4 pr-3 py-3 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-200">کانال <i class="fa-solid fa-bullhorn text-orange-500"></i></button>
                <button onclick="openCreateModal('group')" class="bg-white text-black pl-4 pr-3 py-3 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-200">گروه <i class="fa-solid fa-users text-blue-500"></i></button>
            </div>
            <button onclick="toggleFab()" class="fab-btn w-16 h-16 bg-[var(--c-blue)] rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-[var(--c-blue-dark)]">
                <i class="fa-solid fa-plus transition-transform" id="fab-icon"></i>
            </button>
        </div>
    </div>

    <div id="chat-view" class="flex-1 h-full flex flex-col chat-bg relative">
        <div id="chat-placeholder" class="flex flex-col items-center justify-center h-full text-[var(--c-text-dim)] p-4 text-center">
            <svg class="w-24 h-24 opacity-20" viewBox="0 0 24 24" fill="currentColor"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H5.17L4,17.17V4H20V16Z" /></svg>
            <p class="mt-4">یک گفتگو را از لیست انتخاب کنید</p>
            <p class="text-xs mt-1">یا یک کاربر جدید را برای شروع چت جستجو کنید</p>
        </div>
        <div id="chat-content" class="hidden flex-1 h-full flex flex-col">
            <div id="chat-header" class="h-16 bg-[rgba(24,30,37,0.7)] backdrop-blur-sm flex items-center px-4 justify-between border-b border-[var(--c-border)] shadow-sm flex-shrink-0">
                <div class="flex items-center gap-3 cursor-pointer overflow-hidden">
                    <img id="head-img" class="w-11 h-11 rounded-full object-cover bg-gray-600 flex-shrink-0">
                    <div class="overflow-hidden">
                        <div id="head-name" class="font-bold text-sm truncate"></div>
                        <div id="head-status" class="text-[11px] text-[var(--c-text-dim)]"></div>
                    </div>
                </div>
                <button onclick="openRoomSettings()" id="settings-btn" class="text-[var(--c-text-dim)] w-10 h-10 rounded-full hover:bg-[var(--c-hover)] transition flex-shrink-0"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>
            <div id="join-overlay" class="hidden absolute bottom-24 left-1/2 transform -translate-x-1/2 z-10">
                <button onclick="joinCurrentRoom()" class="bg-[var(--c-blue)] px-8 py-3 rounded-full shadow-xl font-bold hover:bg-[var(--c-blue-dark)] animate-bounce">عضویت در گفتگو</button>
            </div>
            <div id="input-area-wrapper" class="hidden mt-auto">
                 <div id="file-preview-area" class="hidden"></div>
                 <div id="input-area" class="bg-[var(--c-panel)] p-3 flex items-end gap-3 border-t border-[var(--c-border)]">
                    <label for="file-upload" class="cursor-pointer text-[var(--c-text-dim)] p-3 hover:text-white"><i class="fa-solid fa-paperclip text-xl"></i></label>
                    <input type="file" id="file-upload" class="hidden" onchange="prepareFile(this)">
                    <textarea id="msg-text" rows="1" placeholder="پیام..." class="flex-1 bg-transparent outline-none resize-none py-3 max-h-32 text-sm"></textarea>
                    <button onclick="sendMsg()" id="send-btn" class="text-[var(--c-blue)] p-3"><i class="fa-solid fa-paper-plane text-2xl"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-container" class="fixed inset-0 z-[200] hidden items-center justify-center p-4">
    <div onclick="closeModals()" class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm animate__animated animate__fadeIn animate__faster"></div>
    <div id="modal-profile" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden animate__animated animate__fadeInUp animate__faster">
        <h3 class="font-bold text-lg mb-6 text-center">پروفایل من</h3>
        <div class="flex flex-col items-center mb-6">
            <div class="relative group cursor-pointer">
                <img id="p-avatar-preview" class="w-24 h-24 rounded-full object-cover border-4 border-[var(--c-hover)]">
                <label for="p-avatar-upload" class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-2xl"></i></label>
                <input type="file" id="p-avatar-upload" class="hidden" onchange="uploadAvatar(this)">
            </div>
        </div>
        <div class="space-y-3">
            <label class="text-xs text-[var(--c-text-dim)]">نام نمایشی</label>
            <input id="p-name" class="w-full bg-[var(--c-bg)] p-3 rounded-lg outline-none border-2 border-transparent focus:border-[var(--c-blue)]">
            <button onclick="saveProfile()" class="w-full bg-[var(--c-blue)] py-3 rounded-lg font-bold mt-4">ذخیره تغییرات</button>
            <button onclick="doLogout()" class="w-full text-red-400 py-3 text-sm mt-2"><i class="fa-solid fa-power-off"></i> خروج از حساب</button>
            <button onclick="closeModals()" class="w-full text-[var(--c-text-dim)] py-2 text-xs mt-2">بستن</button>
        </div>
    </div>
    <div id="modal-create" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden animate__animated animate__fadeInUp animate__faster">
        <h3 id="create-title" class="font-bold text-lg mb-4">ساخت گروه جدید</h3>
        <div class="space-y-4">
            <input id="new-room-name" placeholder="نام..." class="w-full bg-[var(--c-bg)] p-3 rounded-lg outline-none border-2 border-transparent focus:border-[var(--c-blue)]">
            <div class="flex items-center gap-2">
                <input type="checkbox" id="new-room-private" class="w-4 h-4">
                <label for="new-room-private" class="text-sm text-gray-300">خصوصی (فقط با لینک)</label>
            </div>
            <div class="flex gap-2 pt-2">
                <button onclick="createRoom()" class="flex-1 bg-[var(--c-blue)] py-2 rounded-lg">ایجاد</button>
                <button onclick="closeModals()" class="flex-1 bg-white/10 py-2 rounded-lg">لغو</button>
            </div>
        </div>
    </div>
    <div id="modal-room-settings" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden animate__animated animate__fadeInUp animate__faster">
        <h3 class="font-bold text-lg mb-6 text-center">تنظیمات گفتگو</h3>
        <div class="flex flex-col items-center mb-6">
            <div class="relative group cursor-pointer">
                <img id="rs-avatar-preview" class="w-24 h-24 rounded-full object-cover border-4 border-[var(--c-hover)]">
                <label for="rs-avatar-upload" class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-2xl"></i></label>
                <input type="file" id="rs-avatar-upload" class="hidden" onchange="previewRoomAvatar(this)">
            </div>
        </div>
        <div class="space-y-3">
            <label class="text-xs text-[var(--c-text-dim)]">نام گفتگو</label>
            <input id="rs-name" class="w-full bg-[var(--c-bg)] p-3 rounded-lg outline-none border-2 border-transparent focus:border-[var(--c-blue)]">
            <button onclick="saveRoomSettings()" class="w-full bg-[var(--c-blue)] py-3 rounded-lg font-bold mt-4">ذخیره تغییرات</button>
            <button onclick="closeModals()" class="w-full text-[var(--c-text-dim)] py-2 text-xs mt-2">بستن</button>
        </div>
    </div>
</div>

<script>
const SB_URL = 'https://kdoeoufvsavvihghdhyp.supabase.co';
const SB_KEY = 'sb_publishable_Z-BF5e-PGsesrr18b_laGQ_F0iPU4lk';
const sb = supabase.createClient(SB_URL, SB_KEY);
let me = null, currRoom = null, rooms = [], profiles = [], roomMembers = new Set(), tempFile = { file: null, url: null, type: null, name: null }, tempRoomAvatar = { file: null, url: null }, searchBlurTimeout;

window.onload = async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
        const { data: profile, error } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
        if (profile) { me = profile; await initApp(); } else { console.error("Profile fetch error:", error); showAuth(); }
    } else { showAuth(); }
};
async function initApp() {
    document.getElementById('my-img').src = me.avatar_url || createAvatar(me.username);
    await refreshDataAndRender();
    setupRealtimeListeners();
    show('main-app'); document.getElementById('main-app').classList.add('opacity-100');
}
function showAuth() { document.getElementById('loading').classList.add('hidden'); document.getElementById('auth-page').classList.remove('hidden'); }

async function doLogin() {
    const u = document.getElementById('u-user').value.trim();
    const p = document.getElementById('u-pass').value.trim();
    const n = document.getElementById('u-name').value.trim();
    if (!u || !p) return alert('نام کاربری و رمز عبور الزامی است.');
    const email = `${u}@yooz.ir`;
    let { error } = await sb.auth.signInWithPassword({ email, password: p });
    if (error) {
        if (error.message.includes('Invalid login credentials')) {
            if (!n) return alert('برای ثبت‌نام، نام نمایشی الزامی است.');
            const { error: signUpError } = await sb.auth.signUp({ email, password: p, options: { data: { display_name: n, username: u } } });
            if (signUpError) return alert('خطا در ثبت‌نام: ' + signUpError.message);
        } else { return alert('خطا در ورود: ' + error.message); }
    }
    const { data: { user } } = await sb.auth.getUser();
    const { data: profile } = await sb.from('profiles').select('id').eq('id', user.id).maybeSingle();
    if (!profile) {
        await sb.from('profiles').upsert({ id: user.id, username: u, display_name: n });
    }
    const savedRoomId = `saved_${user.id}`;
    const { data: savedRoom } = await sb.from('rooms').select('id').eq('id', savedRoomId).maybeSingle();
    if (!savedRoom) {
        await sb.from('rooms').upsert({ id: savedRoomId, name: 'پیام‌های ذخیره شده', type: 'saved', owner_id: user.id, is_public: false });
    }
    location.reload();
}
function doLogout() { sb.auth.signOut().then(() => location.reload()); }

function setupRealtimeListeners() {
    sb.channel('yooz_global_channel').on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, refreshDataAndRender).on('postgres_changes', { event: '*', schema: 'public', table: 'room_members' }, refreshDataAndRender).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => { if (currRoom && p.new.room_id === currRoom.id) appendMsg(p.new); }).subscribe();
}
async function refreshDataAndRender() {
    if (!me) return;
    try {
        const [ { data: allR }, { data: j }, { data: allP } ] = await Promise.all([sb.from('rooms').select('*').order('created_at', { ascending: false }), sb.from('room_members').select('room_id').eq('user_id', me.id), sb.from('profiles').select('*')]);
        roomMembers = new Set(j.map(x => x.room_id)); rooms = allR || []; profiles = allP || []; renderChatList();
        if (currRoom) {
            const updatedRoom = rooms.find(r => r.id === currRoom.id);
            if (updatedRoom) { currRoom = updatedRoom; updateChatViewUI(); } else { document.getElementById('chat-content').classList.add('hidden'); document.getElementById('chat-placeholder').classList.remove('hidden'); currRoom = null; }
        }
    } catch(e) { console.error("Data refresh error:", e); }
}
function renderChatList() {
    const list = document.getElementById('chat-list'); list.innerHTML = '';
    const saved = rooms.find(r => r.type === 'saved' && r.owner_id === me.id);
    if (saved) list.insertAdjacentHTML('beforeend', renderRoomItem(saved, true));
    rooms.filter(r => r.type !== 'saved').forEach(r => { if (roomMembers.has(r.id) || r.is_public) list.insertAdjacentHTML('beforeend', renderRoomItem(r)); });
}
function renderRoomItem(r, isSaved = false) {
    const isActive = currRoom?.id === r.id; let icon, name, subText;
    if (r.type === 'dm') {
        const otherId = r.name.replace(me.id, '').replace('_', ''); const other = profiles.find(p => p.id === otherId);
        name = other ? other.display_name : 'کاربر'; icon = other ? (other.avatar_url || createAvatar(other.username)) : createAvatar('?'); subText = 'چت خصوصی';
    } else { name = r.name; icon = r.avatar_url || createAvatar(r.name); subText = r.type === 'channel' ? 'کانال' : 'گروه'; }
    return `<div onclick="openRoom('${r.id}')" class="p-3 flex items-center gap-3 cursor-pointer border-b border-[var(--c-border)] transition ${isActive ? 'bg-[var(--c-blue-dark)]' : 'hover:bg-[var(--c-hover)]'}"><img src="${icon}" class="w-12 h-12 rounded-full object-cover bg-gray-700 f-s-0"><div class="flex-1 overflow-hidden"><div class="flex justify-between items-center"><span class="font-bold text-sm text-white truncate">${name}</span>${isSaved ? '<i class="fa-solid fa-thumbtack text-[11px] text-[var(--c-text-dim)]"></i>' : ''}</div><div class="text-xs text-[var(--c-text-dim)] mt-1 truncate">${subText}</div></div></div>`;
}
function showUserSearch() { clearTimeout(searchBlurTimeout); document.getElementById('chat-list').classList.add('hidden'); document.getElementById('user-search-results').classList.remove('hidden'); }
function hideUserSearch() { searchBlurTimeout = setTimeout(() => { if (document.getElementById('search').value.trim() === '') { document.getElementById('chat-list').classList.remove('hidden'); document.getElementById('user-search-results').classList.add('hidden'); } }, 200); }
function handleSearch(q) {
    const list = document.getElementById('user-search-results'); q = q.trim().toLowerCase(); list.innerHTML = ''; if (q === '') return;
    const results = profiles.filter(p => p.id !== me.id && (p.username.toLowerCase().includes(q) || p.display_name.toLowerCase().includes(q)));
    if (results.length === 0) { list.innerHTML = `<div class="text-center p-8 text-[var(--c-text-dim)]">کاربری یافت نشد.</div>`; return; }
    results.forEach(p => list.insertAdjacentHTML('beforeend', `<div onclick="startDm('${p.id}')" class="p-3 flex items-center gap-3 cursor-pointer hover:bg-[var(--c-hover)] border-b border-[var(--c-border)]"><img src="${p.avatar_url||createAvatar(p.username)}" class="w-12 h-12 rounded-full object-cover"><div><div class="font-bold text-sm">${p.display_name}</div><div class="text-xs text-[var(--c-text-dim)]">@${p.username}</div></div></div>`));
}
async function startDm(otherId) {
    const roomId = [me.id, otherId].sort().join('_'); let { data: room } = await sb.from('rooms').select('*').eq('id', roomId).single();
    if (!room) {
        const { data: newR, error } = await sb.from('rooms').insert({ id: roomId, name: roomId, type: 'dm', owner_id: me.id, is_public: false }).select().single();
        if (error) { console.error(error); return; }
        await sb.from('room_members').insert([{ room_id: roomId, user_id: me.id }, { room_id: roomId, user_id: otherId }]); room = newR;
    }
    document.getElementById('search').value = ''; hideUserSearch(); await refreshDataAndRender(); openRoom(room.id);
}
async function openRoom(id) {
    currRoom = rooms.find(r => r.id === id); if (!currRoom) return;
    document.getElementById('chat-placeholder').classList.add('hidden'); document.getElementById('chat-content').classList.remove('hidden');
    await loadMsgs(); updateChatViewUI(); renderChatList();
}
function updateChatViewUI() {
    document.getElementById('head-name').innerText = currRoom.name; document.getElementById('head-img').src = currRoom.avatar_url || createAvatar(currRoom.name);
    const isOwner = currRoom.owner_id === me.id; document.getElementById('settings-btn').style.display = isOwner && currRoom.type !== 'dm' ? 'block' : 'none';
    const isMember = roomMembers.has(currRoom.id); const inputWrapper = document.getElementById('input-area-wrapper'); const joinOverlay = document.getElementById('join-overlay');
    if (isMember) { inputWrapper.classList.remove('hidden'); joinOverlay.classList.add('hidden'); } else { inputWrapper.classList.add('hidden'); if(currRoom.is_public) joinOverlay.classList.remove('hidden'); }
}
async function joinCurrentRoom() { await sb.from('room_members').insert({ room_id: currRoom.id, user_id: me.id }); }
async function loadMsgs() { const box = document.getElementById('messages'); box.innerHTML = ''; const { data } = await sb.from('messages').select('*').eq('room_id', currRoom.id).order('created_at'); data.forEach(m => appendMsg(m, false)); box.scrollTop = box.scrollHeight; }
function appendMsg(m, animate = true) {
    const box = document.getElementById('messages'); const isMe = m.sender_id === me.id;
    box.insertAdjacentHTML('beforeend', `<div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} ${animate ? 'animate__animated animate__fadeIn' : ''}"><div class="msg shadow-sm p-2 px-3 max-w-[75%] ${isMe ? 'msg-out' : 'msg-in'}"><div class="text-[#5288c1] font-bold text-[10px] mb-1">${m.sender_name}</div>${m.text || ''}<div class="text-[9px] text-gray-400 text-right mt-1">${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div></div>`);
    box.scrollTop = box.scrollHeight;
}
async function sendMsg() {
    const txt = document.getElementById('msg-text').value.trim(); if (!txt) return;
    await sb.from('messages').insert({ room_id: currRoom.id, sender_id: me.id, sender_name: me.display_name, text: txt });
    document.getElementById('msg-text').value = '';
}
function openProfile() { document.getElementById('p-name').value = me.display_name; document.getElementById('p-avatar-preview').src = me.avatar_url || createAvatar(me.username); showModal('modal-profile'); }
async function saveProfile() { const name = document.getElementById('p-name').value; await sb.from('profiles').update({ display_name: name, avatar_url: me.avatar_url }).eq('id', me.id); closeModals(); }
async function uploadAvatar(input) { const f = input.files[0]; if(!f) return; const p = `avatars/${me.id}_${Date.now()}`; await sb.storage.from('yooz_files').upload(p, f, { upsert: true }); const { data: { publicUrl } } = sb.storage.from('yooz_files').getPublicUrl(p); me.avatar_url = publicUrl; document.getElementById('p-avatar-preview').src = publicUrl; }
function openRoomSettings() { document.getElementById('rs-name').value = currRoom.name; document.getElementById('rs-avatar-preview').src = currRoom.avatar_url || createAvatar(currRoom.name); showModal('modal-room-settings'); }
async function saveRoomSettings() { const name = document.getElementById('rs-name').value; let url = currRoom.avatar_url; if(tempRoomAvatar.file){ const p = `avatars/room_${currRoom.id}_${Date.now()}`; await sb.storage.from('yooz_files').upload(p, tempRoomAvatar.file, { upsert: true }); const { data: {publicUrl}} = sb.storage.from('yooz_files').getPublicUrl(p); url = publicUrl; } await sb.from('rooms').update({ name: name, avatar_url: url }).eq('id', currRoom.id); tempRoomAvatar={file:null,url:null}; closeModals(); }
function previewRoomAvatar(i) { const f = i.files[0]; if(!f) return; tempRoomAvatar.file = f; tempRoomAvatar.url = URL.createObjectURL(f); document.getElementById('rs-avatar-preview').src = tempRoomAvatar.url; }
function openCreateModal(type) { createType = type; document.getElementById('create-title').innerText = type === 'group' ? 'ساخت گروه جدید' : 'ساخت کانال جدید'; showModal('modal-create'); toggleFab(); }
async function createRoom() { const name = document.getElementById('new-room-name').value; if(!name) return; const isPrivate = document.getElementById('new-room-private').checked; const id = 'r_' + Date.now(); await sb.from('rooms').insert({ id, name, type: createType, owner_id: me.id, is_public: !isPrivate }); await sb.from('room_members').insert({ room_id: id, user_id: me.id, role: 'admin' }); closeModals(); openRoom(id); }
function toggleFab() { document.getElementById('fab-menu').classList.toggle('open'); document.getElementById('fab-icon').classList.toggle('rotate-45'); }
function show(id) { ['loading', 'auth-page', 'main-app'].forEach(x => document.getElementById(x).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
function showModal(id) { const c = document.getElementById('modal-container'); c.classList.remove('hidden'); c.classList.add('flex'); document.getElementById(id).classList.remove('hidden'); }
function closeModals() { document.getElementById('modal-container').classList.add('hidden'); document.getElementById('modal-container').querySelectorAll('.modal-content').forEach(m => m.classList.add('hidden')); }
function createAvatar(name) {
    if (!name) name = '?'; const colors = ["#3390ec", "#e53935", "#8e24aa", "#00897b", "#fdd835", "#fb8c00"];
    const hash = name.split('').reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0); const color = colors[Math.abs(hash) % colors.length];
    const initial = name.charAt(0).toUpperCase(); const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="${color}"/><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="50" fill="white" font-family="Vazirmatn">${initial}</text></svg>`;
    return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
}
function prepareFile(input) { /* For future file upload feature */ }
</script>
</body>
</html>
