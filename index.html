<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOOZ Messenger | V2.0</title>
    <link rel="icon" href="https://i.ibb.co/6bs5XfK/bg-tile.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap');
        :root { /* ... All CSS variables are the same ... */ }
        body { font-family: 'Vazirmatn', sans-serif; /* ... */ }
        /* Add new styles for reply & modals */
        .reply-preview { background-color: rgba(0,0,0,0.2); border-right: 2px solid var(--c-blue); }
        .message-options {
            display: none;
            position: absolute;
            top: -10px;
            left: -10px;
            background-color: var(--c-panel);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .message-container:hover .message-options { display: flex; }
    </style>
</head>
<body class="flex items-center justify-center">

<!-- All HTML structure (loading, auth, main-app, modals) is the same -->
<!-- A new modal for member management is added -->
<div id="modal-members" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden">
    <h3 class="font-bold text-lg mb-4 text-center">اعضای گروه</h3>
    <div id="member-list" class="max-h-64 overflow-y-auto space-y-2">
        <!-- Member items will be injected here -->
    </div>
    <button onclick="closeModals()" class="w-full text-[var(--c-text-dim)] py-2 text-xs mt-4">بستن</button>
</div>


<script>
// --- CONFIG & GLOBALS ---
const SB_URL = 'https://kdoeoufvsavvihghdhyp.supabase.co';
const SB_KEY = 'sb_publishable_Z-BF5e-PGsesrr18b_laGQ_F0iPU4lk';
const sb = supabase.createClient(SB_URL, SB_KEY);
let app = { me: null, currRoom: null, rooms: [], profiles: [], roomMembers: new Map(), tempFile: {}, tempRoomAvatar: {}, replyingTo: null };

// --- APP INITIALIZATION ---
window.onload = async () => {
    try {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) return showAuth();
        
        // ✅ **FIX:** Load user profile FIRST!
        const { data: profile, error } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
        if (error || !profile) {
            console.error("Critical Error: Profile not found.", error);
            return showAuth();
        }
        app.me = profile;
        
        // ✅ **FIX:** Now that we have the user, load everything else.
        await initApp();

    } catch (e) {
        console.error("Initialization failed:", e);
        showAuth();
    }
};

async function initApp() {
    document.getElementById('my-img').src = app.me.avatar_url || createAvatar(app.me.username);
    await refreshDataAndRender();
    setupRealtimeListeners();
    show('main-app');
    document.getElementById('main-app').classList.add('opacity-100');
}

// ... All other functions (doLogin, doLogout, etc.) are assumed to be complete and correct from previous versions ...

// --- DATA & RENDERING ---
async function refreshDataAndRender() {
    if (!app.me) return; // Safeguard
    try {
        const [ { data: allRooms }, { data: allMembers }, { data: allProfiles } ] = await Promise.all([
            sb.from('rooms').select('*'),
            sb.from('room_members').select('room_id, user_id, role'),
            sb.from('profiles').select('*')
        ]);
        
        app.rooms = allRooms || [];
        app.profiles = allProfiles || [];

        // Create a structured map for members: Map<roomId, Map<userId, role>>
        app.roomMembers.clear();
        allMembers.forEach(m => {
            if (!app.roomMembers.has(m.room_id)) {
                app.roomMembers.set(m.room_id, new Map());
            }
            app.roomMembers.get(m.room_id).set(m.user_id, m.role);
        });
        
        renderChatList();
        if (app.currRoom) {
            // Re-select current room to get fresh data
            app.currRoom = app.rooms.find(r => r.id === app.currRoom.id) || null;
            if (app.currRoom) updateChatViewUI();
            else { /* close chat view if room was deleted */ }
        }
    } catch(e) { console.error("Data refresh error:", e); }
}

// --- MESSAGE ACTIONS (NEW) ---
function setReply(messageId, senderName, text) {
    app.replyingTo = { id: messageId, name: senderName, text: text.substring(0, 50) + '...' };
    const preview = document.getElementById('reply-preview'); // Assume a div with this ID exists above input
    preview.classList.remove('hidden');
    preview.innerHTML = `
        <div class="font-bold text-xs text-[var(--c-blue)]">پاسخ به ${senderName}</div>
        <div class="text-xs truncate">${app.replyingTo.text}</div>
        <button onclick="cancelReply()">&times;</button>
    `;
}

function cancelReply() {
    app.replyingTo = null;
    document.getElementById('reply-preview').classList.add('hidden');
}

async function deleteMessage(messageId) {
    if (!confirm("آیا از حذف این پیام مطمئنید؟")) return;
    const { error } = await sb.from('messages').delete().eq('id', messageId);
    if (error) console.error("Delete error:", error);
    else document.getElementById(`msg-${messageId}`).remove(); // Remove from UI instantly
}

async function forwardMessage(message) {
    // This is a simplified forward. A real app would show a chat picker modal.
    const forwardToRoomId = prompt("ID اتاقی که میخواهید پیام به آن فوروارد شود را وارد کنید:");
    if (!forwardToRoomId) return;
    
    await sb.from('messages').insert({
        room_id: forwardToRoomId,
        sender_id: app.me.id,
        sender_name: app.me.display_name,
        text: message.text,
        file_url: message.file_url,
        file_type: message.file_type,
        // Add a forwarded_from field in your DB for better UI
    });
    alert("پیام فوروارد شد!");
}

// --- RENDERING MESSAGE ---
function appendMsg(m, animate = true) {
    // This function needs to be updated to show options and reply context
    const box = document.getElementById('messages');
    const isMe = m.sender_id === app.me.id;
    const roomAdmins = app.roomMembers.get(m.room_id);
    const myRole = roomAdmins ? roomAdmins.get(app.me.id) : null;
    const canDelete = isMe || myRole === 'admin';

    // Simplified for demonstration
    box.insertAdjacentHTML('beforeend', `
        <div id="msg-${m.id}" class="message-container relative">
            <div class="msg ...">
                <!-- Message content -->
            </div>
            <div class="message-options">
                <button onclick='setReply(${m.id}, "${m.sender_name}", "${m.text}")'><i class="fa-solid fa-reply"></i></button>
                <button onclick='forwardMessage(${JSON.stringify(m)})'><i class="fa-solid fa-share"></i></button>
                ${canDelete ? `<button onclick="deleteMessage(${m.id})"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>
        </div>
    `);
}

// --- SENDING MESSAGE ---
async function sendMsg() {
    const txt = document.getElementById('msg-text').value.trim();
    if (!txt && !app.tempFile.file) return;

    // ... (File upload logic is the same) ...
    let fileUrl = null, fileType = null;
    
    await sb.from('messages').insert({
        room_id: app.currRoom.id,
        sender_id: app.me.id,
        sender_name: app.me.display_name,
        text: txt,
        file_url: fileUrl,
        file_type: fileType,
        reply_to: app.replyingTo ? app.replyingTo.id : null // Save reply reference
    });

    cancelReply(); // Clear reply state
    // ... (Clear inputs) ...
}


// --- MEMBER MANAGEMENT ---
async function openMembersModal() {
    if (!app.currRoom) return;
    const memberMap = app.roomMembers.get(app.currRoom.id);
    if (!memberMap) return;

    const listEl = document.getElementById('member-list');
    listEl.innerHTML = '';
    
    for (const [userId, role] of memberMap.entries()) {
        const profile = app.profiles.find(p => p.id === userId);
        if (!profile) continue;

        listEl.insertAdjacentHTML('beforeend', `
            <div class="flex items-center justify-between p-2 rounded-lg hover:bg-[var(--c-hover)]">
                <div class="flex items-center gap-3">
                    <img src="${profile.avatar_url || createAvatar(profile.username)}" class="w-10 h-10 rounded-full">
                    <div>
                        <div class="font-bold text-sm">${profile.display_name}</div>
                        <div class="text-xs ${role === 'admin' ? 'text-yellow-400' : 'text-[var(--c-text-dim)]'}">${role}</div>
                    </div>
                </div>
                ${app.currRoom.owner_id === app.me.id && userId !== app.me.id ? `
                <button onclick="toggleAdmin('${userId}', '${role}')" class="px-3 py-1 text-xs rounded-full ${role === 'admin' ? 'bg-red-500' : 'bg-green-500'}">
                    ${role === 'admin' ? 'حذف ادمین' : 'ادمین کن'}
                </button>
                ` : ''}
            </div>
        `);
    }
    showModal('modal-members');
}

async function toggleAdmin(userId, currentRole) {
    const newRole = currentRole === 'admin' ? 'member' : 'admin';
    await sb.from('room_members').update({ role: newRole }).eq('room_id', app.currRoom.id).eq('user_id', userId);
    // Realtime will handle the UI update
}

// Include ALL other functions from previous full code versions.
// (showAuth, createAvatar, renderChatList, openRoom, etc.)
</script>
</body>
</html>
