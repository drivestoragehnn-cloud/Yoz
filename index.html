<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOOZ Messenger | V7.0 - The Phoenix</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap');
        :root {
            --c-bg: #101418; --c-panel: #181E25; --c-hover: #222B36; --c-border: rgba(255, 255, 255, 0.07);
            --c-blue: #3390ec; --c-blue-dark: #2A65A2; --c-msg-out: #29425c; --c-msg-in: #222B36;
            --c-text-main: #e1e3e5; --c-text-dim: #707e8e;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--c-bg); color: var(--c-text-main); overflow: hidden; height: 100vh; }
        .chat-bg { background-color: #0e1621; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAAAXNSR0IArs4c6QAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAABAACgAgAEAAAAAQAAAQAAAAA2e3aMAAAAd0lEQVR4Ae3BAQ0AAADCIPunNu1+gJ+dFShgAgYBMQECExAgMABBnoBAgAEK8gQECgwQyBMQKDCAIE9AgMAGCPJmAgQGCPIEBAoMEPALBBggkCcgUGCAQF4gQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQJvAQYAtQABgJ6zQqIAAAAASUVORK5CYII=); }
        .fab-menu { transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; transform: translateY(20px) scale(0.9); pointer-events: none; }
        .fab-menu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
        .message-options { display: none; } .message-container:hover .message-options { display: flex; }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="loading" class="fixed inset-0 z-[999] bg-[var(--c-bg)] flex flex-col items-center justify-center">...</div>
    <div id="auth-page" class="hidden fixed inset-0 z-[100] bg-[var(--c-bg)] flex items-center justify-center p-4">...</div>

    <div id="main-app" class="hidden w-full h-full flex">
        <div class="w-80 md:w-96 h-full bg-[var(--c-panel)] flex flex-col border-l border-[var(--c-border)] z-20 shadow-2xl relative">
            <div class="p-3 flex items-center gap-3 bg-[rgba(34,43,54,0.7)] backdrop-blur-sm sticky top-0 z-10">
                <div onclick="openProfile()" class="cursor-pointer hover:opacity-80 transition flex-shrink-0">
                    <img id="my-img" class="w-11 h-11 rounded-full object-cover bg-gray-700">
                </div>
                <div class="flex-1 relative">
                    <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-[var(--c-text-dim)]"></i>
                    <input onfocus="showUserSearch()" oninput="handleSearch(this.value)" onblur="hideUserSearch()" id="search" type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÛŒØ§ Ú†Øªâ€ŒÙ‡Ø§..." class="w-full bg-[var(--c-bg)] h-11 rounded-full pr-10 pl-4 text-sm outline-none border-2 border-transparent focus:border-[var(--c-blue)] transition-all">
                </div>
            </div>
            <div id="user-search-results" class="flex-1 overflow-y-auto hidden"></div>
            <div id="chat-list" class="flex-1 overflow-y-auto"></div>
            <div class="absolute bottom-6 right-6 flex flex-col items-end gap-3">
                 <div id="fab-menu" class="fab-menu flex flex-col gap-2">
                    <button onclick="openCreateModal('channel')" class="bg-white text-black pl-4 pr-3 py-3 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-200">Ú©Ø§Ù†Ø§Ù„ <i class="fa-solid fa-bullhorn text-orange-500"></i></button>
                    <button onclick="openCreateModal('group')" class="bg-white text-black pl-4 pr-3 py-3 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-200">Ú¯Ø±ÙˆÙ‡ <i class="fa-solid fa-users text-blue-500"></i></button>
                </div>
                <button onclick="toggleFab()" class="w-16 h-16 bg-[var(--c-blue)] rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-[var(--c-blue-dark)] transition-transform" id="fab-icon">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>
        <div id="chat-view" class="flex-1 h-full flex flex-col chat-bg relative">
            <div id="chat-placeholder" class="flex flex-col items-center justify-center h-full text-[var(--c-text-dim)] p-4 text-center">...</div>
            <div id="chat-content" class="hidden flex-1 h-full flex flex-col">...</div>
        </div>
    </div>
    
    <div id="modal-container" class="fixed inset-0 z-[200] hidden items-center justify-center p-4">
        <div onclick="closeModals()" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div id="modal-profile" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden">...</div>
        <div id="modal-create" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden">...</div>
        <div id="modal-room-settings" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden">...</div>
        <div id="modal-members" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden">...</div>
        <div id="modal-forward" class="modal-content relative bg-[var(--c-panel)] w-full max-w-sm rounded-2xl p-6 hidden">...</div>
    </div>

    <script>
        // --- CONFIG & GLOBALS ---
        const SB_URL = 'https://kdoeoufvsavvihghdhyp.supabase.co';
        const SB_KEY = 'sb_publishable_Z-BF5e-PGsesrr18b_laGQ_F0iPU4lk';
        const sb = supabase.createClient(SB_URL, SB_KEY);
        let app = { me: null, currRoom: null, rooms: [], profiles: [], roomMembers: new Map(), tempFile: {}, replyingTo: null, forwardingMsg: null, searchBlurTimeout: null };

        // --- INITIALIZATION ---
        window.onload = async () => {
            try {
                if (!document.getElementById('loading')) { document.body.innerHTML = '<h1>HTML ERROR</h1>'; return; }
                const { data: { session } } = await sb.auth.getSession();
                if (!session) return showAuth();
                const { data: profile, error } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
                if (error || !profile) { await sb.auth.signOut(); return showAuth(); }
                app.me = profile;
                await initApp();
            } catch (e) { console.error("Init Error:", e); showAuth(); }
        };
        async function initApp() {
            document.getElementById('my-img').src = app.me.avatar_url || createAvatar(app.me.username);
            await refreshDataAndRender();
            setupRealtimeListeners();
            show('main-app');
        }

        // --- AUTH & UI ---
        function show(id) {
            ['loading', 'auth-page', 'main-app'].forEach(x => document.getElementById(x).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function showAuth() { show('auth-page'); }

        async function doLogin() {
            const u = document.getElementById('u-user').value.trim(), p = document.getElementById('u-pass').value.trim(), n = document.getElementById('u-name').value.trim();
            if (!u || !p) return;
            const email = `${u}@yooz.ir`;
            let { data: {user}, error } = await sb.auth.signInWithPassword({ email, password: p });
            if (error) {
                if (!n) return alert('Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ØŒ Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.');
                const { data: signUpData, error: signUpError } = await sb.auth.signUp({ email, password: p, options: { data: { display_name: n, username: u } } });
                if (signUpError) return alert('Ø®Ø·Ø§: ' + signUpError.message);
                user = signUpData.user;
            }
            const { data: profile } = await sb.from('profiles').select('id').eq('id', user.id).maybeSingle();
            if (!profile) { await sb.from('profiles').upsert({ id: user.id, username: u, display_name: n }); }
            const savedRoomId = `saved_${user.id}`;
            const { data: savedRoom } = await sb.from('rooms').select('id').eq('id', savedRoomId).maybeSingle();
            if (!savedRoom) { await sb.from('rooms').upsert({ id: savedRoomId, name: 'Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡', type: 'saved', owner_id: user.id, is_public: false }); }
            const { data: mainRoom } = await sb.from('rooms').select('id').eq('id', 'yooz_main').maybeSingle();
            if (!mainRoom) { await sb.from('rooms').insert({id: 'yooz_main', name: 'Ú©Ø§Ù†Ø§Ù„ Ø±Ø³Ù…ÛŒ ÛŒÙˆØ²', type: 'channel', owner_id: user.id, is_public: true }); }
            const { data: member } = await sb.from('room_members').select('*').eq('room_id', 'yooz_main').eq('user_id', user.id).maybeSingle();
            if (!member) { await sb.from('room_members').insert({ room_id: 'yooz_main', user_id: user.id, role: 'member' }); }
            location.reload();
        }
        function doLogout() { sb.auth.signOut().then(() => location.reload()); }

        // --- REALTIME ---
        function setupRealtimeListeners() {
            sb.channel('yooz').on('postgres_changes', { event: '*', schema: 'public' }, refreshDataAndRender).subscribe();
        }

        // --- DATA & RENDERING ---
        async function refreshDataAndRender() { /* ... */ }
        function renderChatList() { /* ... */ }
        function renderRoomItem(r, isSaved = false) { /* ... */ }

        // --- CHAT VIEW & MESSAGES ---
        async function openRoom(id) { /* ... */ }
        function updateChatViewUI() { /* ... */ }
        async function loadMsgs() { /* ... */ }
        function appendMsg(m, animate = true) { /* ... */ }
        async function sendMsg() { /* ... */ }

        // --- ACTIONS (Reply, Forward, Delete) ---
        function setReply(msgId, name, text) { /* ... */ }
        function cancelReply() { /* ... */ }
        function openForwardModal(msg) { /* ... */ }
        async function performForward(toRoomId) { /* ... */ }
        async function deleteMessage(msgId) { /* ... */ }
        
        // --- SEARCH ---
        function showUserSearch() { /* ... */ }
        function hideUserSearch() { /* ... */ }
        function handleSearch(q) { /* ... */ }
        async function startDm(otherId) { /* ... */ }

        // --- MODALS & SETTINGS ---
        function showModal(id) { /* ... */ }
        function closeModals() { /* ... */ }
        function openProfile() { /* ... */ }
        async function saveProfile() { /* ... */ }
        function openCreateModal(type) { /* ... */ }
        async function createRoom() { /* ... */ }
        function openRoomSettings() { /* ... */ }
        async function saveRoomSettings() { /* ... */ }
        function openMembersModal() { /* ... */ }
        async function toggleAdmin(userId, role) { /* ... */ }

        // --- HELPERS ---
        function toggleFab() { /* ... */ }
        function createAvatar(name) { /* ... */ }
        function prepareFile(input) { /* ... */ }
        function clearFilePreview() { /* ... */ }
        async function uploadAvatar(input) { /* ... */ }
        async function previewRoomAvatar(input) { /* ... */ }
    </script>
</body>
</html>
