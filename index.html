<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YOOZ Messenger | V2</title>
<link rel="icon" href="https://i.ibb.co/6bs5XfK/bg-tile.png"> <!-- ✅ آدرس لوگو درست شد -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap');
    :root {
        --c-bg: #101418; --c-panel: #181E25; --c-hover: #222B36; --c-border: rgba(255, 255, 255, 0.07);
        --c-blue: #3390ec; --c-blue-dark: #2A65A2; --c-msg-out: #29425c; --c-msg-in: #222B36;
        --c-text-main: #e1e3e5; --c-text-dim: #707e8e;
    }
    body { font-family: 'Vazirmatn', sans-serif; background-color: var(--c-bg); color: var(--c-text-main); overflow: hidden; height: 100vh; }
    .chat-bg { background-color: var(--c-bg); background-image: url("https://i.ibb.co/6bs5XfK/bg-tile.png"); background-size: 500px; }
    .msg-in { background: var(--c-msg-in); border-radius: 18px 18px 18px 5px; align-self: flex-start; }
    .msg-out { background: var(--c-msg-out); border-radius: 18px 18px 5px 18px; align-self: flex-end; }
    .fab-btn { transition: all 0.3s ease; } .fab-btn:active { transform: scale(0.9); }
    .fab-menu { transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; transform: translateY(20px) scale(0.9); pointer-events: none; }
    .fab-menu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .modal-backdrop { transition: backdrop-filter 0.3s ease, background-color 0.3s ease; }
    .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #2c3848; border-radius: 3px; }
    #file-preview-area { background-color: var(--c-hover); border-top: 1px solid var(--c-border); padding: 8px 12px; font-size: 13px; display: flex; align-items: center; justify-content: space-between; }
</style>
</head>
<body class="flex items-center justify-center">

<!-- All HTML content is the same as the previous full version, so it's omitted for brevity but should be included -->
<div id="loading" class="fixed inset-0 z-[999] bg-[var(--c-bg)] flex flex-col items-center justify-center transition-opacity duration-300">...</div>
<div id="auth-page" class="hidden fixed inset-0 z-[100] bg-[var(--c-bg)] flex items-center justify-center p-4">...</div>
<div id="main-app" class="hidden w-full h-full flex transition-opacity duration-500 opacity-0">...</div>
<div id="modal-container" class="fixed inset-0 z-[200] hidden items-center justify-center p-4">...</div>

<script>
const SB_URL = 'https://kdoeoufvsavvihghdhyp.supabase.co';
const SB_KEY = 'sb_publishable_Z-BF5e-PGsesrr18b_laGQ_F0iPU4lk';
const sb = supabase.createClient(SB_URL, SB_KEY);
let me = null, currRoom = null, rooms = [], profiles = [], roomMembers = new Set(), tempFile = { file: null, name: null }, tempRoomAvatar = { file: null, url: null }, searchBlurTimeout;

// All other JS functions like window.onload, doLogin, initApp, etc. are THE SAME as the previous complete code.
// The key changes are in `prepareFile` and `sendMsg`.

async function sendMsg() {
    const txt = document.getElementById('msg-text').value.trim();
    const fileToUpload = tempFile.file;

    if (!txt && !fileToUpload) return; // اگر نه متن و نه فایلی بود، خارج شو

    document.getElementById('send-btn').disabled = true;
    let fileUrl = null;
    let fileType = null;

    // ✅ موتور آپلود فایل اینجاست
    if (fileToUpload) {
        const path = `files/${me.id}_${Date.now()}_${fileToUpload.name}`;
        const { error: uploadError } = await sb.storage.from('yooz_files').upload(path, fileToUpload);
        
        if (uploadError) {
            console.error('File upload error:', uploadError);
            alert('خطا در آپلود فایل!');
            document.getElementById('send-btn').disabled = false;
            return;
        }
        
        const { data } = sb.storage.from('yooz_files').getPublicUrl(path);
        fileUrl = data.publicUrl;
        fileType = fileToUpload.type.startsWith('image/') ? 'image' : 'file';
    }

    // ارسال پیام به دیتابیس
    await sb.from('messages').insert({
        room_id: currRoom.id,
        sender_id: me.id,
        sender_name: me.display_name,
        text: txt,
        file_url: fileUrl, // آدرس فایل آپلود شده
        file_type: fileType // نوع فایل
    });

    // تمیزکاری
    document.getElementById('msg-text').value = '';
    clearFilePreview();
    document.getElementById('send-btn').disabled = false;
}

// ✅ این تابع هم کامل شد
function prepareFile(input) {
    const file = input.files[0];
    if (!file) return;

    tempFile = { file: file, name: file.name };
    
    const previewArea = document.getElementById('file-preview-area');
    previewArea.classList.remove('hidden');
    
    const icon = file.type.startsWith('image/') ? 'fa-image' : 'fa-file-zipper';
    
    previewArea.innerHTML = `
        <i class="fa-solid ${icon} ml-2 text-[var(--c-blue)]"></i>
        <span class="truncate flex-1 mx-2">${file.name}</span>
        <button onclick="clearFilePreview()" class="text-red-400 hover:text-red-600">&times;</button>
    `;
}

function clearFilePreview() {
    tempFile = { file: null, name: null };
    document.getElementById('file-upload').value = ''; // Reset the input
    const previewArea = document.getElementById('file-preview-area');
    previewArea.classList.add('hidden');
    previewArea.innerHTML = '';
}


function appendMsg(m, animate = true) {
    const box = document.getElementById('messages');
    const isMe = m.sender_id === me.id;

    let fileContent = '';
    // ✅ نمایش فایل و عکس در چت
    if (m.file_url) {
        if (m.file_type === 'image') {
            fileContent = `<img src="${m.file_url}" class="max-w-[250px] rounded-lg mt-2 cursor-pointer" onclick="window.open('${m.file_url}')">`;
        } else {
            fileContent = `<a href="${m.file_url}" target="_blank" class="block bg-black/20 p-3 rounded-lg mt-2 text-sm text-blue-300 flex items-center gap-2"><i class="fa-solid fa-download"></i> <span>دانلود فایل</span></a>`;
        }
    }
    
    const textContent = m.text ? `<div class="text-white">${m.text.replace(/\n/g, '<br>')}</div>` : '';

    const msgHTML = `
        <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} ${animate ? 'animate__animated animate__fadeIn' : ''}">
            <div class="msg shadow-sm p-2 px-3 max-w-[75%] ${isMe ? 'msg-out' : 'msg-in'}">
                <div class="text-[#5288c1] font-bold text-xs mb-1">${m.sender_name}</div>
                ${textContent}
                ${fileContent}
                <div class="text-[10px] text-gray-400 text-right mt-2">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
            </div>
        </div>`;
    box.insertAdjacentHTML('beforeend', msgHTML);
    box.scrollTop = box.scrollHeight;
}


// --- PASTE ALL OTHER JAVASCRIPT FUNCTIONS FROM THE PREVIOUS COMPLETE CODE HERE ---
// (doLogin, initApp, doLogout, setupRealtimeListeners, refreshDataAndRender, etc. are all needed)

</script>
</body>
</html>
